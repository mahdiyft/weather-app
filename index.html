<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>날씨 الان WeatherNow</title>
    <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0f2f5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .weather-result {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .weather-result:hover {
            transform: translateY(-2px);
        }

        .temp {
            font-size: 1.5rem;
            margin: 12px 0;
            font-weight: 600;
            color: #2c3e50;
        }

        .back-button {
            text-align: center;
            margin-top: 20px;
            padding: 10px 16px;
            background-color: #3498db;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: inline-block;
            font-weight: 500;
        }

        .back-button:hover {
            background-color: #2980b9;
        }

        img {
            vertical-align: middle;
        }

        .weather-card {
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 300px;
        }

        .weather-card h3 {
            margin-top: 0;
            font-size: 1.2rem;
        }

        .weather-card p {
            margin: 8px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="text-align:center; margin: 1rem 0;">پیش بینی هوا</h1>
        <div id="weather-container"></div>
    </div>

    <script>
        const API_KEY = '2a98a59b571a3309e5e2e8f5658d09ce'; // Replace with your OpenWeatherMap API key
        const city = 'Tehran'; // Default city

        // async function getWeatherData(city) {
        //   try {
        //     const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}`);
        //     if (!response.ok) {
        //         throw new Error(`API Error: ${response.status} ${response.statusText}`);
        //     }
        //     return await response.json();
        //   } catch (error) {
        //     console.error('Error fetching weather data:', error);
        //     throw error;
        //   }
        // }

        // function displayWeather(data) {
        //   const container = document.getElementById('weather-container');
        //   if (!data || data.cod !== 200) {
        //     container.innerHTML = '<div class="weather-result">متاسفانه داده‌های پیش‌بینی هوا پیدا نشد.</div>';
        //     return;
        //   }

        //   const days = {};
        //   data.list.forEach(item => {
        //     const date = item.dt_txt.split(' ')[0];
        //     if (!days[date]) {
        //       days[date] = {
        //         date,
        //         tempMin: item.main.temp_min,
        //         tempMax: item.main.temp_max,
        //         condition: item.weather[0]
        //       };
        //     } else {
        //       days[date].tempMin = Math.min(days[date].tempMin, item.main.temp_min);
        //       days[date].tempMax = Math.max(days[date].tempMax, item.main.temp_max);
        //     }
        //   });


        async function getWeatherData(city) {
            try {
                // Step 1: First fetch the geographic coordinates using city name
                const geoResponse = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${API_KEY}&units=metric`
                );
                const geoData = await geoResponse.json();

                if (geoData.cod !== 200) {
                    throw new Error(geoData.message || "City not found");
                }

                const lat = geoData.coord.lat;
                const lon = geoData.coord.lon;

                // Step 2: Now fetch the 5-day forecast using the retrieved coordinates
                const forecastResponse = await fetch(
                    `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`
                );
                const forecastData = await forecastResponse.json();

                displayWeather(forecastData);

            } catch (error) {
                console.error('Error fetching weather data:', error);
            }
        }

        function displayWeather(data) {
            if (!data.list) return;

            const container = document.getElementById('weather-container');
            container.innerHTML = ''; // Clear existing content

            // Process data into daily aggregates
            const days = {};
            data.list.forEach(item => {
                const date = new Date(item.dt * 1000).toISOString().split('T')[0]; // Extract date as "YYYY-MM-DD"
                if (!days[date]) {
                    days[date] = {
                        date: date,
                        description: item.weather[0].description,
                        tempMin: item.main.temp_min.toFixed(1), // Use correct data path
                        tempMax: item.main.temp_max.toFixed(1)  // Use correct data path
                    };
                }
            });

            // Convert object to array and sort by date
            const dailyForecast = Object.keys(days).map(date => days[date]);
            dailyForecast.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Create and append weather cards
            dailyForecast.forEach((day, index) => {
                const card = document.createElement('div');
                card.className = 'weather-card';
                card.innerHTML = `
            <h3>Day ${index + 1}: ${day.date}</h3>
            <p><strong>Description:</strong> ${day.description}</p>
            <p><strong>Min Temp:</strong> ${day.tempMin}°C</p>
            <p><strong>Max Temp:</strong> ${day.tempMax}°C</p>
        `;
                container.appendChild(card);
            });
        }

    //     function displayWeather(forecastData) {
    //         const weatherContainer = document.getElementById('weather-container'); // Ensure you have a container with this ID
    //         console.log(forecastData);
    //         const groupedByDate = forecastData.reduce((acc, day) => {
    //             const date = day.date.split(' ')[0]; // Use date string formatted as "YYYY-MM-DD"
    //             if (!acc[date]) {
    //                 acc[date] = {
    //                     date,
    //                     description: day.description,
    //                     temp_min: day.temp_min,
    //                     temp_max: day.temp_max,
    //                 };
    //             } else {
    //                 // Update if a lower temp_min or higher temp_max is found
    //                 acc[date].temp_min = Math.min(acc[date].temp_min, day.temp_min);
    //                 acc[date].temp_max = Math.max(acc[date].temp_max, day.temp_max);
    //             }
    //             return acc;
    //         }, {});

    //         // Render each day as a separate card
    //         Object.values(groupedByDate).forEach(day => {
    //             const card = document.createElement('div');
    //             card.className = 'weather-card';
    //             card.innerHTML = `
    //   <h3>${day.date}</h3>
    //   <p><strong>Condition:</strong> ${day.description}</p>
    //   <p><strong>Min Temp:</strong> ${day.temp_min}°C</p>
    //   <p><strong>Max Temp:</strong> ${day.temp_max}°C</p>
    // `;
    //             weatherContainer.appendChild(card);
    //         });
    //     }


        function createBackButton() {
            const button = document.createElement('div');
            button.className = 'back-button';
            button.textContent = 'بازگشت به منو';
            button.onclick = () => {
                document.location.href = document.location.href;
            };
            document.body.appendChild(button);
        }

        // Initial load
        (async () => {
            try {
                await getWeatherData(city);
            } catch (error) {
                console.error('Initialization error:', error);
            }
        })();

        window.addEventListener('popstate', () => {
            location.reload();
        });
    </script>
</body>

</html>